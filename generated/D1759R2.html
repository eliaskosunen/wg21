<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="mpark/wg21" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2019-12-12" />
  <title>Native handle from file streams</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style>
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f6f8fa; }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span. { } /* Normal */
code span.al { color: #ff0000; } /* Alert */
code span.an { } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #9f6807; } /* BaseN */
code span.bu { color: #9f6807; } /* BuiltIn */
code span.cf { color: #00607c; } /* ControlFlow */
code span.ch { color: #9f6807; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; font-style: italic; } /* Comment */
code span.cv { color: #008000; font-style: italic; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.dt { color: #00607c; } /* DataType */
code span.dv { color: #9f6807; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #9f6807; } /* Float */
code span.fu { } /* Function */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #00607c; } /* Keyword */
code span.op { color: #af1915; } /* Operator */
code span.ot { } /* Other */
code span.pp { color: #6f4e37; } /* Preprocessor */
code span.re { } /* RegionMarker */
code span.sc { color: #9f6807; } /* SpecialChar */
code span.ss { color: #9f6807; } /* SpecialString */
code span.st { color: #9f6807; } /* String */
code span.va { } /* Variable */
code span.vs { color: #9f6807; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */
code.diff {color: #898887}
code.diff span.va {color: #006e28}
code.diff span.st {color: #bf0303}
  </style>
  <style type="text/css">
body {
margin: 5em;
font-family: serif;

hyphens: auto;
line-height: 1.35;
}
div.wrapper {
max-width: 60em;
margin: auto;
}
ul {
list-style-type: none;
padding-left: 2em;
margin-top: -0.2em;
margin-bottom: -0.2em;
}
a {
text-decoration: none;
color: #4183C4;
}
a.hidden_link {
text-decoration: none;
color: inherit;
}
li {
margin-top: 0.6em;
margin-bottom: 0.6em;
}
h1, h2, h3, h4 {
position: relative;
line-height: 1;
}
a.self-link {
position: absolute;
top: 0;
left: calc(-1 * (3.5rem - 26px));
width: calc(3.5rem - 26px);
height: 2em;
text-align: center;
border: none;
transition: opacity .2s;
opacity: .5;
font-family: sans-serif;
font-weight: normal;
font-size: 83%;
}
a.self-link:hover { opacity: 1; }
a.self-link::before { content: "§"; }
ul > li:before {
content: "\2014";
position: absolute;
margin-left: -1.5em;
}
:target { background-color: #C9FBC9; }
:target .codeblock { background-color: #C9FBC9; }
:target ul { background-color: #C9FBC9; }
.abbr_ref { float: right; }
.folded_abbr_ref { float: right; }
:target .folded_abbr_ref { display: none; }
:target .unfolded_abbr_ref { float: right; display: inherit; }
.unfolded_abbr_ref { display: none; }
.secnum { display: inline-block; min-width: 35pt; }
.header-section-number { display: inline-block; min-width: 35pt; }
.annexnum { display: block; }
div.sourceLinkParent {
float: right;
}
a.sourceLink {
position: absolute;
opacity: 0;
margin-left: 10pt;
}
a.sourceLink:hover {
opacity: 1;
}
a.itemDeclLink {
position: absolute;
font-size: 75%;
text-align: right;
width: 5em;
opacity: 0;
}
a.itemDeclLink:hover { opacity: 1; }
span.marginalizedparent {
position: relative;
left: -5em;
}
li span.marginalizedparent { left: -7em; }
li ul > li span.marginalizedparent { left: -9em; }
li ul > li ul > li span.marginalizedparent { left: -11em; }
li ul > li ul > li ul > li span.marginalizedparent { left: -13em; }
div.footnoteNumberParent {
position: relative;
left: -4.7em;
}
a.marginalized {
position: absolute;
font-size: 75%;
text-align: right;
width: 5em;
}
a.enumerated_item_num {
position: relative;
left: -3.5em;
display: inline-block;
margin-right: -3em;
text-align: right;
width: 3em;
}
div.para { margin-bottom: 0.6em; margin-top: 0.6em; text-align: justify; }
div.section { text-align: justify; }
div.sentence { display: inline; }
span.indexparent {
display: inline;
position: relative;
float: right;
right: -1em;
}
a.index {
position: absolute;
display: none;
}
a.index:before { content: "⟵"; }

a.index:target {
display: inline;
}
.indexitems {
margin-left: 2em;
text-indent: -2em;
}
div.itemdescr {
margin-left: 3em;
}
.bnf {
font-family: serif;
margin-left: 40pt;
margin-top: 0.5em;
margin-bottom: 0.5em;
}
.ncbnf {
font-family: serif;
margin-top: 0.5em;
margin-bottom: 0.5em;
margin-left: 40pt;
}
.ncsimplebnf {
font-family: serif;
font-style: italic;
margin-top: 0.5em;
margin-bottom: 0.5em;
margin-left: 40pt;
background: inherit; 
}
span.textnormal {
font-style: normal;
font-family: serif;
white-space: normal;
display: inline-block;
}
span.rlap {
display: inline-block;
width: 0px;
}
span.descr { font-style: normal; font-family: serif; }
span.grammarterm { font-style: italic; }
span.term { font-style: italic; }
span.terminal { font-family: monospace; font-style: normal; }
span.nonterminal { font-style: italic; }
span.tcode { font-family: monospace; font-style: normal; }
span.textbf { font-weight: bold; }
span.textsc { font-variant: small-caps; }
a.nontermdef { font-style: italic; font-family: serif; }
span.emph { font-style: italic; }
span.techterm { font-style: italic; }
span.mathit { font-style: italic; }
span.mathsf { font-family: sans-serif; }
span.mathrm { font-family: serif; font-style: normal; }
span.textrm { font-family: serif; }
span.textsl { font-style: italic; }
span.mathtt { font-family: monospace; font-style: normal; }
span.mbox { font-family: serif; font-style: normal; }
span.ungap { display: inline-block; width: 2pt; }
span.textit { font-style: italic; }
span.texttt { font-family: monospace; }
span.tcode_in_codeblock { font-family: monospace; font-style: normal; }
span.phantom { color: white; }

span.math { font-style: normal; }
span.mathblock {
display: block;
margin-left: auto;
margin-right: auto;
margin-top: 1.2em;
margin-bottom: 1.2em;
text-align: center;
}
span.mathalpha {
font-style: italic;
}
span.synopsis {
font-weight: bold;
margin-top: 0.5em;
display: block;
}
span.definition {
font-weight: bold;
display: block;
}
.codeblock {
margin-left: 1.2em;
line-height: 127%;
}
.outputblock {
margin-left: 1.2em;
line-height: 127%;
}
div.itemdecl {
margin-top: 2ex;
}
code.itemdeclcode {
white-space: pre;
display: block;
}
span.textsuperscript {
vertical-align: super;
font-size: smaller;
line-height: 0;
}
.footnotenum { vertical-align: super; font-size: smaller; line-height: 0; }
.footnote {
font-size: small;
margin-left: 2em;
margin-right: 2em;
margin-top: 0.6em;
margin-bottom: 0.6em;
}
div.minipage {
display: inline-block;
margin-right: 3em;
}
div.numberedTable {
text-align: center;
margin: 2em;
}
div.figure {
text-align: center;
margin: 2em;
}
table {
border: 1px solid black;
border-collapse: collapse;
margin-left: auto;
margin-right: auto;
margin-top: 0.8em;
text-align: left;
hyphens: none; 
}
td, th {
padding-left: 1em;
padding-right: 1em;
vertical-align: top;
}
td.empty {
padding: 0px;
padding-left: 1px;
}
td.left {
text-align: left;
}
td.right {
text-align: right;
}
td.center {
text-align: center;
}
td.justify {
text-align: justify;
}
td.border {
border-left: 1px solid black;
}
tr.rowsep, td.cline {
border-top: 1px solid black;
}
tr.even, tr.odd {
border-bottom: 1px solid black;
}
tr.capsep {
border-top: 3px solid black;
border-top-style: double;
}
tr.header {
border-bottom: 3px solid black;
border-bottom-style: double;
}
th {
border-bottom: 1px solid black;
}
span.centry {
font-weight: bold;
}
div.table {
display: block;
margin-left: auto;
margin-right: auto;
text-align: center;
width: 90%;
}
span.indented {
display: block;
margin-left: 2em;
margin-bottom: 1em;
margin-top: 1em;
}
ol.enumeratea { list-style-type: none; background: inherit; }
ol.enumerate { list-style-type: none; background: inherit; }

code.sourceCode > span { display: inline; }

div#refs p { padding-left: 32px; text-indent: -32px; }
</style>
  <link href="data:image/vnd.microsoft.icon;base64,AAABAAIAEBAAAAEAIABoBAAAJgAAACAgAAABACAAqBAAAI4EAAAoAAAAEAAAACAAAAABACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////AIJEAACCRAAAgkQAAIJEAACCRAAAgkQAVoJEAN6CRADegkQAWIJEAACCRAAAgkQAAIJEAACCRAAA////AP///wCCRAAAgkQAAIJEAACCRAAsgkQAvoJEAP+CRAD/gkQA/4JEAP+CRADAgkQALoJEAACCRAAAgkQAAP///wD///8AgkQAAIJEABSCRACSgkQA/IJEAP99PQD/dzMA/3czAP99PQD/gkQA/4JEAPyCRACUgkQAFIJEAAD///8A////AHw+AFiBQwDqgkQA/4BBAP9/PxP/uZd6/9rJtf/bybX/upd7/39AFP+AQQD/gkQA/4FDAOqAQgBc////AP///wDKklv4jlEa/3o7AP+PWC//8+3o///////////////////////z7un/kFox/35AAP+GRwD/mVYA+v///wD///8A0Zpk+NmibP+0d0T/8evj///////+/fv/1sKz/9bCs//9/fr//////+/m2/+NRwL/nloA/5xYAPj///8A////ANKaZPjRmGH/5cKh////////////k149/3UwAP91MQD/lmQ//86rhv+USg3/m1YA/5hSAP+bVgD4////AP///wDSmmT4zpJY/+/bx///////8+TV/8mLT/+TVx//gkIA/5lVAP+VTAD/x6B//7aEVv/JpH7/s39J+P///wD///8A0ppk+M6SWP/u2sf///////Pj1f/Nj1T/2KFs/8mOUv+eWhD/lEsA/8aee/+0glT/x6F7/7J8Rvj///8A////ANKaZPjRmGH/48Cf///////+/v7/2qt//82PVP/OkFX/37KJ/86siv+USg7/mVQA/5hRAP+bVgD4////AP///wDSmmT40ppk/9CVXP/69O////////7+/v/x4M//8d/P//7+/f//////9u7n/6tnJf+XUgD/nFgA+P///wD///8A0ppk+NKaZP/RmWL/1qNy//r07///////////////////////+vXw/9akdP/Wnmn/y5FY/6JfFvj///8A////ANKaZFTSmmTo0ppk/9GYYv/Ql1//5cWm//Hg0P/x4ND/5cWm/9GXYP/RmGH/0ppk/9KaZOjVnmpY////AP///wDSmmQA0ppkEtKaZI7SmmT60ppk/9CWX//OkVb/zpFW/9CWX//SmmT/0ppk/NKaZJDSmmQS0ppkAP///wD///8A0ppkANKaZADSmmQA0ppkKtKaZLrSmmT/0ppk/9KaZP/SmmT/0ppkvNKaZCrSmmQA0ppkANKaZAD///8A////ANKaZADSmmQA0ppkANKaZADSmmQA0ppkUtKaZNzSmmTc0ppkVNKaZADSmmQA0ppkANKaZADSmmQA////AP5/AAD4HwAA4AcAAMADAACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAMADAADgBwAA+B8AAP5/AAAoAAAAIAAAAEAAAAABACAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////AP///wCCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAAyCRACMgkQA6oJEAOqCRACQgkQAEIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAA////AP///wD///8A////AIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRABigkQA5oJEAP+CRAD/gkQA/4JEAP+CRADqgkQAZoJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAAD///8A////AP///wD///8AgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAA4gkQAwoJEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQAxIJEADyCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAAgkQAAP///wD///8A////AP///wCCRAAAgkQAAIJEAACCRAAAgkQAAIJEAACCRAAWgkQAmIJEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAJyCRAAYgkQAAIJEAACCRAAAgkQAAIJEAACCRAAA////AP///wD///8A////AIJEAACCRAAAgkQAAIJEAACCRAAAgkQAdIJEAPCCRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAP+CRAD/gkQA/4JEAPSCRAB4gkQAAIJEAACCRAAAgkQAAIJEAAD///8A////AP///wD///8AgkQAAIJEAACCRAAAgkQASoJEANKCRAD/gkQA/4JEAP+CRAD/g0YA/39AAP9zLgD/bSQA/2shAP9rIQD/bSQA/3MuAP9/PwD/g0YA/4JEAP+CRAD/gkQA/4JEAP+CRADUgkQAToJEAACCRAAAgkQAAP///wD///8A////AP///wB+PwAAgkUAIoJEAKiCRAD/gkQA/4JEAP+CRAD/hEcA/4BBAP9sIwD/dTAA/5RfKv+viF7/vp56/76ee/+wiF7/lWAr/3YxAP9sIwD/f0AA/4RHAP+CRAD/gkQA/4JEAP+CRAD/gkQArIJEACaBQwAA////AP///wD///8A////AIBCAEBzNAD6f0EA/4NFAP+CRAD/gkQA/4VIAP92MwD/bSUA/6N1Tv/ezsL/////////////////////////////////38/D/6V3Uv9uJgD/dTEA/4VJAP+CRAD/gkQA/4JEAP+BQwD/fUAA/4FDAEj///8A////AP///wD///8AzJRd5qBlKf91NgD/dDUA/4JEAP+FSQD/cy4A/3YyAP/PuKP//////////////////////////////////////////////////////9K7qP94NQD/ciwA/4VJAP+CRAD/fkEA/35BAP+LSwD/mlYA6v///wD///8A////AP///wDdpnL/4qx3/8KJUv+PUhf/cTMA/3AsAP90LgD/4dK+/////////////////////////////////////////////////////////////////+TYxf91MAD/dTIA/31CAP+GRwD/llQA/6FcAP+gWwD8////AP///wD///8A////ANGZY/LSm2X/4ap3/92mcP+wdT3/byQA/8mwj////////////////////////////////////////////////////////////////////////////+LYxv9zLgP/jUoA/59bAP+hXAD/nFgA/5xYAPL///8A////AP///wD///8A0ppk8tKaZP/RmWL/1p9q/9ubXv/XqXj////////////////////////////7+fD/vZyG/6BxS/+gcUr/vJuE//r37f//////////////////////3MOr/5dQBf+dVQD/nVkA/5xYAP+cWAD/nFgA8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/SmWP/yohJ//jo2P//////////////////////4NTG/4JDFf9lGAD/bSQA/20kAP9kGAD/fz8S/+Xb0f//////5NG9/6txN/+LOgD/m1QA/51aAP+cWAD/m1cA/5xYAP+cWADy////AP///wD///8A////ANKaZPLSmmT/0ppk/8+TWf/Unmv//v37//////////////////////+TWRr/VwsA/35AAP+ERgD/g0UA/4JGAP9lHgD/kFga/8KXX/+TRwD/jT4A/49CAP+VTQD/n10A/5xYAP+OQQD/lk4A/55cAPL///8A////AP///wD///8A0ppk8tKaZP/SmmT/y4tO/92yiP//////////////////////8NnE/8eCQP+rcTT/ez0A/3IyAP98PgD/gEMA/5FSAP+USwD/jj8A/5lUAP+JNwD/yqV2/694Mf+HNQD/jkAA/82rf/+laBj/jT4A8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/LiUr/4byY///////////////////////gupX/0I5P/+Wuev/Lklz/l1sj/308AP+QSwD/ol0A/59aAP+aVQD/k0oA/8yoh///////+fXv/6pwO//Lp3v///////Pr4f+oay7y////AP///wD///8A////ANKaZPLSmmT/0ppk/8uJSv/hvJj//////////////////////+G7l//Jhkb/0ppk/96nc//fqXX/x4xO/6dkFP+QSQD/llEA/5xXAP+USgD/yaOA///////38uv/qG05/8ijdv//////8efb/6ZpLPL///8A////AP///wD///8A0ppk8tKaZP/SmmT/zIxO/9yxh///////////////////////7dbA/8iEQf/Sm2X/0Zlj/9ScZv/eqHf/2KJv/7yAQf+XTgD/iToA/5lSAP+JNgD/yKFv/611LP+HNQD/jT8A/8qmeP+kZRT/jT4A8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/Pk1n/1J5q//78+//////////////////+/fv/1aFv/8iEQv/Tm2b/0ppl/9GZY//Wn2z/1pZc/9eldf/Bl2b/kUcA/4w9AP+OQAD/lUwA/59eAP+cWQD/jT8A/5ZOAP+eXADy////AP///wD///8A////ANKaZPLSmmT/0ppk/9KZY//KiEn/8d/P///////////////////////47+f/05tm/8iCP//KiEj/yohJ/8eCP//RmGH//vfy///////n1sP/rXQ7/4k4AP+TTAD/nVoA/5xYAP+cVwD/nFgA/5xYAPL///8A////AP///wD///8A0ppk8tKaZP/SmmT/0ptl/8uLTf/aq37////////////////////////////+/fz/6c2y/961jv/etY7/6Myx//78+v//////////////////////3MWv/5xXD/+ORAD/mFQA/51ZAP+cWAD/nFgA8v///wD///8A////AP///wDSmmTy0ppk/9KaZP/SmmT/0ppk/8mFRP/s1b//////////////////////////////////////////////////////////////////////////////+PD/0JFU/7NzMv+WUQD/kUsA/5tXAP+dWQDy////AP///wD///8A////ANKaZP/SmmT/0ppk/9KaZP/Sm2X/z5NZ/8yMT//z5NX/////////////////////////////////////////////////////////////////9Ofa/8yNUP/UmGH/36p5/8yTWv+qaSD/kksA/5ROAPz///8A////AP///wD///8A0ppk5NKaZP/SmmT/0ppk/9KaZP/TnGf/zY9T/82OUv/t1sD//////////////////////////////////////////////////////+7Yw//OkFX/zI5R/9OcZ//SmmP/26V0/9ymdf/BhUf/ol8R6P///wD///8A////AP///wDSmmQ80ppk9tKaZP/SmmT/0ppk/9KaZP/TnGj/zpFW/8qJSv/dson/8uHS//////////////////////////////////Lj0//etIv/y4lL/86QVf/TnGj/0ppk/9KaZP/RmWP/05xn/9ymdfjUnWdC////AP///wD///8A////ANKaZADSmmQc0ppkotKaZP/SmmT/0ppk/9KaZP/Tm2b/0Zli/8qJSf/NjlH/16Z3/+G8mP/myKr/5siq/+G8mP/Xp3f/zY5S/8qISf/RmGH/05tm/9KaZP/SmmT/0ppk/9KaZP/SmmSm0pljINWdaQD///8A////AP///wD///8A0ppkANKaZADSmmQA0ppkQtKaZMrSmmT/0ppk/9KaZP/SmmT/0ptl/9GYYf/Nj1P/y4lL/8qISP/KiEj/y4lK/82PU//RmGH/0ptl/9KaZP/SmmT/0ppk/9KaZP/SmmTO0ppkRtKaZADSmmQA0ppkAP///wD///8A////AP///wDSmmQA0ppkANKaZADSmmQA0ppkANKaZGzSmmTu0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmTw0ppkcNKaZADSmmQA0ppkANKaZADSmmQA////AP///wD///8A////ANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZBLSmmSQ0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppklNKaZBTSmmQA0ppkANKaZADSmmQA0ppkANKaZAD///8A////AP///wD///8A0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQy0ppkutKaZP/SmmT/0ppk/9KaZP/SmmT/0ppk/9KaZP/SmmT/0ppkvtKaZDbSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkAP///wD///8A////AP///wDSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkXNKaZODSmmT/0ppk/9KaZP/SmmT/0ppk5NKaZGDSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA////AP///wD///8A////ANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkBtKaZIbSmmTo0ppk6tKaZIrSmmQK0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZADSmmQA0ppkANKaZAD///8A////AP/8P///+B///+AH//+AAf//AAD//AAAP/AAAA/gAAAHwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA+AAAAfwAAAP/AAAP/8AAP//gAH//+AH///4H////D//" rel="icon" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  
</head>
<body>
<div class="wrapper">
<header id="title-block-header">
<h1 class="title" style="text-align:center">Native handle from file streams</h1>

<table style="border:none;float:right">
  <tr>
    <td>Document #: </td>
    <td>D1759R2</td>
  </tr>
  <tr>
    <td>Date: </td>
    <td>2019-12-12</td>
  </tr>
  <tr>
    <td style="vertical-align:top">Project: </td>
    <td>Programming Language C++<br>
      Library Evolution<br>
    </td>
  </tr>
  <tr>
    <td style="vertical-align:top">Reply-to: </td>
    <td>
      Elias Kosunen<br>&lt;<a href="mailto:isocpp@eliaskosunen.com" class="email">isocpp@eliaskosunen.com</a>&gt;<br>
    </td>
  </tr>
</table>

</header>
<div style="clear:both">
<div id="TOC" role="doc-toc">
<h1 id="toctitle">Contents</h1>
<ul>
<li><a href="#abstract"><span class="toc-section-number">1</span> Abstract<span></span></a></li>
<li><a href="#history"><span class="toc-section-number">2</span> Revision History<span></span></a><ul>
<li><a href="#r2"><span class="toc-section-number">2.1</span> R2<span></span></a></li>
<li><a href="#r1"><span class="toc-section-number">2.2</span> R1<span></span></a></li>
<li><a href="#r0"><span class="toc-section-number">2.3</span> R0<span></span></a></li>
</ul></li>
<li><a href="#motivation"><span class="toc-section-number">3</span> Motivation<span></span></a></li>
<li><a href="#scope"><span class="toc-section-number">4</span> Scope<span></span></a></li>
<li><a href="#design"><span class="toc-section-number">5</span> Design Discussion<span></span></a><ul>
<li><a href="#handle-type"><span class="toc-section-number">5.1</span> Type of <code>native_handle_type</code><span></span></a></li>
<li><a href="#precond"><span class="toc-section-number">5.2</span> Precondition<span></span></a></li>
</ul></li>
<li><a href="#impact"><span class="toc-section-number">6</span> Impact On the Standard and Existing Code<span></span></a></li>
<li><a href="#implementation"><span class="toc-section-number">7</span> Implementation<span></span></a></li>
<li><a href="#prior-art"><span class="toc-section-number">8</span> Prior Art<span></span></a><ul>
<li><a href="#discussion"><span class="toc-section-number">8.1</span> Discussion<span></span></a></li>
<li><a href="#precendent"><span class="toc-section-number">8.2</span> Existing precendent for presence of <code>native_handle</code><span></span></a></li>
</ul></li>
<li><a href="#standardese"><span class="toc-section-number">9</span> Technical Specifications<span></span></a><ul>
<li><a href="#ft-macro"><span class="toc-section-number">9.1</span> Feature test macro<span></span></a></li>
<li><a href="#wording"><span class="toc-section-number">9.2</span> Wording<span></span></a><ul>
<li><a href="#add-the-following-subsection-into-file-based-streams-file.streams"><span class="toc-section-number">9.2.1</span> Add the following subsection into <em>File-based streams</em> [<strong>file.streams</strong>]<span></span></a></li>
<li><a href="#modify-class-template-basic_filebuf-filebuf"><span class="toc-section-number">9.2.2</span> Modify <em>Class template <code>basic_filebuf</code></em> [<strong>filebuf</strong>]<span></span></a></li>
<li><a href="#modify-class-template-basic_filebuf-filebuf-1"><span class="toc-section-number">9.2.3</span> Modify <em>Class template <code>basic_filebuf</code></em> [<strong>filebuf</strong>]<span></span></a></li>
<li><a href="#add-to-the-end-of-member-functions-filebuf.members"><span class="toc-section-number">9.2.4</span> Add to the end of <em>Member functions</em> [<strong>filebuf.members</strong>]<span></span></a></li>
<li><a href="#modify-class-template-basic_ifstream-ifstream"><span class="toc-section-number">9.2.5</span> Modify <em>Class template <code>basic_ifstream</code></em> [<strong>ifstream</strong>]<span></span></a></li>
<li><a href="#add-to-member-functions-ifstream.members-after-p1"><span class="toc-section-number">9.2.6</span> Add to <em>Member functions</em> [<strong>ifstream.members</strong>] after p1<span></span></a></li>
<li><a href="#modify-class-template-basic_ofstream-ofstream"><span class="toc-section-number">9.2.7</span> Modify <em>Class template <code>basic_ofstream</code></em> [<strong>ofstream</strong>]<span></span></a></li>
<li><a href="#add-to-member-functions-ofstream.members-after-p1"><span class="toc-section-number">9.2.8</span> Add to <em>Member functions</em> [<strong>ofstream.members</strong>] after p1<span></span></a></li>
<li><a href="#modify-class-template-basic_fstream-fstream"><span class="toc-section-number">9.2.9</span> Modify <em>Class template <code>basic_fstream</code></em> [<strong>fstream</strong>]<span></span></a></li>
<li><a href="#add-to-member-functions-fstream.members-after-p1"><span class="toc-section-number">9.2.10</span> Add to <em>Member functions</em> [<strong>fstream.members</strong>] after p1<span></span></a></li>
</ul></li>
</ul></li>
<li><a href="#acknowledgements"><span class="toc-section-number">10</span> Acknowledgements<span></span></a></li>
<li><a href="#references"><span class="toc-section-number">11</span> References<span></span></a></li>
</ul>
</div>

<h1 id="abstract"><span class="header-section-number">1</span> Abstract<a href="#abstract" class="self-link"></a></h1>
<p>This paper proposes adding a new typedef to standard file streams: <code>native_handle_type</code>. This type is an alias to whatever type the platform uses for its file descriptors: <code>int</code> on POSIX, <code>HANDLE</code> (<code>void*</code>) on Windows, and something else on other platforms. This type is a non-owning handle and is to be small, <code>Regular</code>, standard layout, and trivially copyable.</p>
<p>Alongside this, this paper proposes adding a concrete member function: <code>.native_handle()</code>, returning a <code>native_handle_type</code>, to the following class templates:</p>
<ul>
<li><code>basic_filebuf</code></li>
<li><code>basic_ifstream</code></li>
<li><code>basic_ofstream</code></li>
<li><code>basic_fstream</code></li>
</ul>
<h1 id="history"><span class="header-section-number">2</span> Revision History<a href="#history" class="self-link"></a></h1>
<h2 id="r2"><span class="header-section-number">2.1</span> R2<a href="#r2" class="self-link"></a></h2>
<ul>
<li>Minor touches to wording</li>
<li>Update reference to the WD</li>
<li>Editorial fixes</li>
</ul>
<h2 id="r1"><span class="header-section-number">2.2</span> R1<a href="#r1" class="self-link"></a></h2>
<ul>
<li>Make <code>native_handle_type</code> be standard layout</li>
<li>Add precondition (<code>is_open() == true</code>) to <code>.native_handle()</code></li>
<li>Add feature test macro <code>__cpp_lib_fstream_native_handle</code></li>
<li>Fix errors with opening the file with POSIX APIs in Motivation (see, we need this paper, fstreams are easier to open correctly!)</li>
<li>Add additional motivating use case in vectored/scatter-gather IO</li>
<li><code>Regular</code> -&gt; <code>regular</code></li>
</ul>
<p>Incorporate LEWGI feedback from Cologne (July 2019):</p>
<ul>
<li>Move to a member function and member typedef</li>
<li>Make <code>native_handle</code> return value not be mandated to be unique</li>
<li>Add note about how the presence of the members is required, and not implementation-defined (like for thread)</li>
</ul>
<h2 id="r0"><span class="header-section-number">2.3</span> R0<a href="#r0" class="self-link"></a></h2>
<p>Initial revision.</p>
<h1 id="motivation"><span class="header-section-number">3</span> Motivation<a href="#motivation" class="self-link"></a></h1>
<p>For some operations, using OS/platform-specific file APIs is necessary. If this is the case, one is unable to use iostreams, without reopening the file, with the platform-specific APIs.</p>
<p>For example, if one wanted to query the time a file was last modified on POSIX, one would use <code>::fstat</code>, which takes a file descriptor:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1"></a><span class="dt">int</span> fd <span class="op">=</span> <span class="op">::</span>open<span class="op">(</span><span class="st">&quot;~/foo.txt&quot;</span>, O_RDONLY<span class="op">)</span>;</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="op">::</span>stat s<span class="op">{}</span>;</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="dt">int</span> err <span class="op">=</span> <span class="op">::</span>fstat<span class="op">(</span>fd, <span class="op">&amp;</span>s<span class="op">)</span>;</span>
<span id="cb1-4"><a href="#cb1-4"></a>std<span class="op">::</span>chrono<span class="op">::</span>sys_seconds last_modified <span class="op">=</span> std<span class="op">::</span>chrono<span class="op">::</span>seconds<span class="op">(</span>s<span class="op">.</span>st_mtime<span class="op">.</span>tv_sec<span class="op">)</span>;</span></code></pre></div>
<p>[ <em>Note:</em> The Filesystem TS introduced the <code>file_status</code> structure and <code>status</code> function, which returns one. This doesn’t solve our problem, because <code>std::filesystem::status</code> takes a path, not a native file descriptor (using paths is potentially racy). Also, <code>std::filesystem::file_status</code> only contains member functions <code>type()</code> and <code>permissions()</code>, not one for last time of modification. Extending this structure is out of scope for this proposal, and not feasible for every single possible operation the user may wish to do with OS APIs. — <em>end note</em> ]</p>
<p>If the user needs to do a single operation not supported by the standard library, they have to make choice between only using OS APIs, or reopening the file every time it’s necessary. The former is unfortunate from the persective of the standard library. The latter is likely to lead to forgetting to close the file, or running into buffering or synchronization issues.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">// Writing the latest modification date to a file</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>std<span class="op">::</span>chrono<span class="op">::</span>sys_seconds last_modified<span class="op">(</span><span class="dt">int</span> fd<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>    <span class="co">// See above for POSIX implementation</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="op">}</span></span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co">// Today&#39;s code</span></span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">// Option #1:</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="co">// Use iostreams by reopening the file</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="op">{</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>    <span class="dt">int</span> fd <span class="op">=</span> <span class="op">::</span>open<span class="op">(</span><span class="st">&quot;~/foo.txt&quot;</span>, O_RDONLY<span class="op">)</span>; <span class="co">// CreateFile on Windows</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>    <span class="kw">auto</span> lm <span class="op">=</span> last_modified<span class="op">(</span>fd<span class="op">)</span>;</span>
<span id="cb2-13"><a href="#cb2-13"></a></span>
<span id="cb2-14"><a href="#cb2-14"></a>    <span class="op">::</span>close<span class="op">(</span>fd<span class="op">)</span>; <span class="co">// CloseFile on Windows</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>    <span class="co">// Hope the path still points to the file!</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>    <span class="co">// Need to allocate </span></span>
<span id="cb2-17"><a href="#cb2-17"></a>    std<span class="op">::</span>ofstream of<span class="op">(</span><span class="st">&quot;~/foo.txt&quot;</span><span class="op">)</span>;</span>
<span id="cb2-18"><a href="#cb2-18"></a>    of <span class="op">&lt;&lt;</span> std<span class="op">::</span>chrono<span class="op">::</span>format<span class="op">(</span><span class="st">&quot;</span><span class="sc">%c</span><span class="st">&quot;</span>, lm<span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="ch">&#39;</span><span class="sc">\n</span><span class="ch">&#39;</span>;</span>
<span id="cb2-19"><a href="#cb2-19"></a>    <span class="co">// Need to flush</span></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="op">}</span></span>
<span id="cb2-21"><a href="#cb2-21"></a></span>
<span id="cb2-22"><a href="#cb2-22"></a><span class="co">// Option #2:</span></span>
<span id="cb2-23"><a href="#cb2-23"></a><span class="co">// Abstain from using iostreams altogether</span></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="op">{</span></span>
<span id="cb2-25"><a href="#cb2-25"></a>    <span class="dt">int</span> fd <span class="op">=</span> <span class="op">::</span>open<span class="op">(</span><span class="st">&quot;~/foo.txt&quot;</span>, O_RDWR<span class="op">)</span>;</span>
<span id="cb2-26"><a href="#cb2-26"></a>    <span class="kw">auto</span> lm <span class="op">=</span> last_modified<span class="op">(</span>fd<span class="op">)</span>;</span>
<span id="cb2-27"><a href="#cb2-27"></a></span>
<span id="cb2-28"><a href="#cb2-28"></a>    <span class="co">// Using ::write() is clunky;</span></span>
<span id="cb2-29"><a href="#cb2-29"></a>    <span class="co">// skipping error handling for brevity</span></span>
<span id="cb2-30"><a href="#cb2-30"></a>    <span class="kw">auto</span> str <span class="op">=</span> std<span class="op">::</span>chrono<span class="op">::</span>format<span class="op">(</span><span class="st">&quot;</span><span class="sc">%c</span><span class="st">&quot;</span>, lm<span class="op">)</span>;</span>
<span id="cb2-31"><a href="#cb2-31"></a>    str<span class="op">.</span>push_back<span class="op">(</span><span class="ch">&#39;</span><span class="sc">\n</span><span class="ch">&#39;</span><span class="op">)</span>;</span>
<span id="cb2-32"><a href="#cb2-32"></a>    <span class="op">::</span>write<span class="op">(</span>fd, str<span class="op">.</span>data<span class="op">()</span>, str<span class="op">.</span>size<span class="op">())</span>;</span>
<span id="cb2-33"><a href="#cb2-33"></a>    <span class="co">// Remember to close!</span></span>
<span id="cb2-34"><a href="#cb2-34"></a>    <span class="co">// Hope format or push_back doesn&#39;t throw</span></span>
<span id="cb2-35"><a href="#cb2-35"></a>    <span class="op">::</span>close<span class="op">(</span>fd<span class="op">)</span>;</span>
<span id="cb2-36"><a href="#cb2-36"></a><span class="op">}</span></span>
<span id="cb2-37"><a href="#cb2-37"></a></span>
<span id="cb2-38"><a href="#cb2-38"></a><span class="co">// This proposal</span></span>
<span id="cb2-39"><a href="#cb2-39"></a><span class="co">// No need to use platform-specific APIs to open the file</span></span>
<span id="cb2-40"><a href="#cb2-40"></a><span class="op">{</span></span>
<span id="cb2-41"><a href="#cb2-41"></a>    std<span class="op">::</span>ofstream of<span class="op">(</span><span class="st">&quot;~/foo.txt&quot;</span><span class="op">)</span>;</span>
<span id="cb2-42"><a href="#cb2-42"></a>    <span class="kw">auto</span> lm <span class="op">=</span> last_modified<span class="op">(</span>of<span class="op">.</span>native_handle<span class="op">())</span>;</span>
<span id="cb2-43"><a href="#cb2-43"></a>    of <span class="op">&lt;&lt;</span> std<span class="op">::</span>chrono<span class="op">::</span>format<span class="op">(</span><span class="st">&quot;</span><span class="sc">%c</span><span class="st">&quot;</span>, lm<span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="ch">&#39;</span><span class="sc">\n</span><span class="ch">&#39;</span>;</span>
<span id="cb2-44"><a href="#cb2-44"></a>    <span class="co">// RAII does ownership handling for us</span></span>
<span id="cb2-45"><a href="#cb2-45"></a><span class="op">}</span></span></code></pre></div>
<p>The utility of getting a file descriptor (or other native file handle) is not limited to getting the last modification date. Other examples include, but are definitely not limited to:</p>
<ul>
<li>file locking (<code>fcntl()</code> + <code>F_SETLK</code> on POSIX, <code>LockFile</code> on Windows)</li>
<li>getting file status flags (<code>fcntl()</code> + <code>F_GETFL</code> on POSIX, <code>GetFileInformationByHandle</code> on Windows)</li>
<li>vectored/scatter-gather IO (<code>vread()</code>/<code>vwrite()</code> on POSIX)</li>
<li>non-blocking IO (<code>fcntl()</code> + <code>O_NONBLOCK</code>/<code>F_SETSIG</code> on POSIX)</li>
</ul>
<p>Basically, this paper would make standard file streams interoperable with operating system interfaces, making iostreams more useful in that regard.</p>
<p>An alternative would be adding a lot of this functionality to <code>fstream</code> and <code>filesystem</code>. The problem is, that some of this behavior is inherently platform-specific. For example, getting the inode of a file is something that only makes sense on POSIX, so cannot be made part of the <code>fstream</code> interface, and is only accessible through the native file descriptor.</p>
<p>Facilities replacing iostreams, although desirable, are not going to be available in the standard in the near future. The author, alongside many others, would thus find this functionality useful.</p>
<h1 id="scope"><span class="header-section-number">4</span> Scope<a href="#scope" class="self-link"></a></h1>
<p>This paper does <em>not</em> propose constructing a file stream or stream buffer from a native file handle. The author is worried of ownership and implementation issues possibly associated with this design.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">// NOT PROPOSED</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="pp">#include </span><span class="im">&lt;fstream&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="kw">auto</span> fd <span class="op">=</span> <span class="op">::</span>open<span class="op">(</span><span class="co">/* ... */</span><span class="op">)</span>;</span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="kw">auto</span> f <span class="op">=</span> std<span class="op">::</span>fstream<span class="op">{</span>fd<span class="op">}</span>;</span></code></pre></div>
<p>This paper also does <em>not</em> touch anything related to <code>FILE*</code>, namely getting a native handle out of one.</p>
<h1 id="design"><span class="header-section-number">5</span> Design Discussion<a href="#design" class="self-link"></a></h1>
<h2 id="handle-type"><span class="header-section-number">5.1</span> Type of <code>native_handle_type</code><a href="#handle-type" class="self-link"></a></h2>
<p>In this paper, the definition for <code>native_handle_type</code> is <em>much</em> more strict than in <code>thread</code>. For reference, this is the wording from <em>32.2.3 Native handles</em> [<strong>thread.req.native</strong>], from <span class="citation" data-cites="N4830">[<a href="#ref-N4830" role="doc-biblioref">N4830</a>]</span>:</p>
<blockquote>
<p>Several classes described in this Clause have members <code>native_handle_type</code> and <code>native_handle</code>. The presence of these members and their semantics is implementation-defined. [ <em>Note:</em> These members allow implementations to provide access to implementation details. Their names are specified to facilitate portable compile-time detection. Actual use of these members is inherently non-portable. — <em>end note</em> ]</p>
</blockquote>
<p>During the review of R0 of this paper in Cologne by LEWGI, an implementor mentioned how having the same specification here would make this paper effectively useless. Having the presence of a member be implementation-defined without a feature detect macro was deemed as bad design, which should not be replicated in this paper.</p>
<p>The proposed alternative in this paper, as directed by LEWGI, is allowing a conforming implementation to return an invalid native file handle, if one cannot be retrieved.</p>
<h2 id="precond"><span class="header-section-number">5.2</span> Precondition<a href="#precond" class="self-link"></a></h2>
<p>The member function <code>.native_handle()</code>, as specified in this paper, has a precondition of <code>.is_open() == true</code>. The precondition is specified with “Expects”, so breaking it would be UB, and would in practice be enforced with an assert.</p>
<p>An alternative to this would be throwing if the file is not open, or returning some unspecified invalid handle.</p>
<h1 id="impact"><span class="header-section-number">6</span> Impact On the Standard and Existing Code<a href="#impact" class="self-link"></a></h1>
<p>This proposal is a pure library extension, requiring no changes to the core language. It would cause no existing conforming code to break.</p>
<h1 id="implementation"><span class="header-section-number">7</span> Implementation<a href="#implementation" class="self-link"></a></h1>
<p>Implementing this paper should be a relatively trivial task.</p>
<p>Although all implementations surveyed (libstdc++, libc++ and MSVC) use <code>FILE*</code> instead of native file descriptors in their <code>basic_filebuf</code> implementations, these platforms provide facilites to get a native handle from a <code>FILE*</code>; <code>fileno</code> on POSIX, and <code>_fileno</code> + <code>_get_osfhandle</code> on Windows. The following reference implementations use these.</p>
<p>For libstdc++ on Linux:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> CharT, <span class="kw">class</span> Traits<span class="op">&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">class</span> basic_filebuf <span class="op">:</span> <span class="kw">public</span> basic_streambuf<span class="op">&lt;</span>CharT, Traits<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>    <span class="co">// ...</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>    <span class="kw">using</span> native_handle_type <span class="op">=</span> <span class="dt">int</span>;</span>
<span id="cb4-5"><a href="#cb4-5"></a>    <span class="co">// ...</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>    native_handle_type native_handle<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>        <span class="ot">assert</span><span class="op">(</span>is_open<span class="op">())</span>;</span>
<span id="cb4-8"><a href="#cb4-8"></a>        <span class="co">// _M_file (__basic_file&lt;char&gt;) has a member function for this purpose</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>        <span class="cf">return</span> _M_file<span class="op">.</span>fd<span class="op">()</span>;</span>
<span id="cb4-10"><a href="#cb4-10"></a>        <span class="co">// ::fileno(_M_file.file()) could also be used</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>    <span class="op">}</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>    <span class="co">// ...</span></span>
<span id="cb4-13"><a href="#cb4-13"></a><span class="op">}</span></span></code></pre></div>
<p>For libc++ on Linux:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> CharT, <span class="kw">class</span> Traits<span class="op">&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="kw">class</span> basic_filebuf <span class="op">:</span> <span class="kw">public</span> basic_streambuf<span class="op">&lt;</span>CharT, Traits<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>    <span class="co">// ...</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>    <span class="kw">using</span> native_handle_type <span class="op">=</span> <span class="dt">int</span>;</span>
<span id="cb5-5"><a href="#cb5-5"></a>    <span class="co">// ...</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>    native_handle_type native_handle<span class="op">()</span> <span class="op">{</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>        <span class="ot">assert</span><span class="op">(</span>is_open<span class="op">())</span>;</span>
<span id="cb5-8"><a href="#cb5-8"></a>        <span class="co">// __file_ is a FILE*</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>        <span class="cf">return</span> <span class="op">::</span>fileno<span class="op">(</span>__file_<span class="op">)</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>    <span class="op">}</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>    <span class="co">// ...</span></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="op">}</span></span></code></pre></div>
<p>For MSVC:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> CharT, <span class="kw">class</span> Traits<span class="op">&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">class</span> basic_filebuf <span class="op">:</span> <span class="kw">public</span> basic_streambuf<span class="op">&lt;</span>CharT, Traits<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>    <span class="co">// ...</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>    <span class="kw">using</span> native_handle_type <span class="op">=</span> HANDLE;</span>
<span id="cb6-5"><a href="#cb6-5"></a>    <span class="co">// ...</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>    native_handle_type native_handle<span class="op">()</span> <span class="op">{</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>        <span class="ot">assert</span><span class="op">(</span>is_open<span class="op">())</span>;</span>
<span id="cb6-8"><a href="#cb6-8"></a>        <span class="co">// _Myfile is a FILE*</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>        <span class="kw">auto</span> cfile <span class="op">=</span> <span class="op">::</span>_fileno<span class="op">(</span>_Myfile<span class="op">)</span>;</span>
<span id="cb6-10"><a href="#cb6-10"></a>        <span class="co">// _get_osfhandle returns intptr_t, which can be cast to HANDLE (void*)</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>        <span class="cf">return</span> <span class="kw">static_cast</span><span class="op">&lt;</span>HANDLE<span class="op">&gt;(::</span>_get_osfhandle<span class="op">(</span>cfile<span class="op">))</span>;</span>
<span id="cb6-12"><a href="#cb6-12"></a>    <span class="op">}</span></span>
<span id="cb6-13"><a href="#cb6-13"></a>    <span class="co">// ...</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="op">}</span></span></code></pre></div>
<p>For all of these cases, implementing <code>.native_handle()</code> for <code>ifstream</code>, <code>ofstream</code> and <code>fstream</code> is trivial:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> CharT, <span class="kw">class</span> Traits<span class="op">&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="kw">class</span> basic_ifstream <span class="op">:</span> <span class="kw">public</span> basic_istream<span class="op">&lt;</span>CharT, Traits<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>    <span class="co">// ...</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>    <span class="kw">using</span> native_handle_type <span class="op">=</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>        <span class="kw">typename</span> basic_filebuf<span class="op">&lt;</span>CharT, Traits<span class="op">&gt;::</span>native_handle_type;</span>
<span id="cb7-6"><a href="#cb7-6"></a>    <span class="co">// ...</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>    native_handle_type native_handle<span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>        <span class="cf">return</span> rdbuf<span class="op">()-&gt;</span>native_handle<span class="op">()</span>;</span>
<span id="cb7-9"><a href="#cb7-9"></a>    <span class="op">}</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="op">}</span>;</span>
<span id="cb7-11"><a href="#cb7-11"></a></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="co">// Repeat for ofstream and fstream</span></span></code></pre></div>
<h1 id="prior-art"><span class="header-section-number">8</span> Prior Art<a href="#prior-art" class="self-link"></a></h1>
<p><span class="citation" data-cites="Boost.IOStreams">[<span class="citeproc-not-found" data-reference-id="Boost.IOStreams"><strong>???</strong></span>]</span> provides <code>file_descriptor</code>, <code>file_descriptor_source</code>, and <code>file_descriptor_sink</code>, which, when used in conjunction with <code>stream_buffer</code>, are <code>std::basic_streambuf</code>s using a file descriptor. These classes can be constructed from a path or a native handle (<code>int</code> or <code>HANDLE</code>) and can also return it with member function <code>handle()</code>.</p>
<p>The Networking TS <span class="citation" data-cites="N4734">[<a href="#ref-N4734" role="doc-biblioref">N4734</a>]</span> has members <code>native_handle_type</code> and <code>.native_handle()</code> in numerous places, including <code>std::net::socket</code>. It specifies (in [<strong>socket.reqmts.native</strong>]) the presence of these members in a similar fashion to <code>thread</code>, as in making their presence implementation-defined. It does, however, recommend POSIX-based systems to use <code>int</code> for this purpose.</p>
<p>Niall Douglas’s <span class="citation" data-cites="P1031">[<span class="citeproc-not-found" data-reference-id="P1031"><strong>???</strong></span>]</span> also defined a structure <code>native_handle_type</code> with an extensive interface and a member <code>union</code> with an <code>int</code> and a <code>HANDLE</code>, with a constructor taking either one of these.</p>
<h2 id="discussion"><span class="header-section-number">8.1</span> Discussion<a href="#discussion" class="self-link"></a></h2>
<p>There has been some discussion over the years about various things relating to this issue, but as far as the author is aware, no concrete proposal has ever been submitted.</p>
<p>There have been a number of threads on std-discussion and std-proposals: <span class="citation" data-cites="std-proposals-native-handle">[<span class="citeproc-not-found" data-reference-id="std-proposals-native-handle"><strong>???</strong></span>]</span>, <span class="citation" data-cites="std-discussion-fd-io">[<span class="citeproc-not-found" data-reference-id="std-discussion-fd-io"><strong>???</strong></span>]</span>, <span class="citation" data-cites="std-proposals-native-raw-io">[<span class="citeproc-not-found" data-reference-id="std-proposals-native-raw-io"><strong>???</strong></span>]</span>, <span class="citation" data-cites="std-proposals-fd-access">[<span class="citeproc-not-found" data-reference-id="std-proposals-fd-access"><strong>???</strong></span>]</span>. The last one of these lead to a draft paper, that was never submitted: <span class="citation" data-cites="access-file-descriptors">[<span class="citeproc-not-found" data-reference-id="access-file-descriptors"><strong>???</strong></span>]</span>.</p>
<p>The consensus that the author took from these discussions is, that native handle support for iostreams would be very much welcome.</p>
<p>An objection was raised by Billy O’Neal to being able to retrieve a native file handle from a standard file stream:</p>
<blockquote>
<p>[This] also would need to mandate that the C++ streams be implemented directly such that there was a 1:1 native handle relationship, which may not be the case. For instance, a valid implementation of C++ iostreams would be on top of cstdio, which would not have any kind of native handle to expose.</p>
<p>– Billy O’Neal: <span class="citation" data-cites="std-proposals-billy-oneal">[<span class="citeproc-not-found" data-reference-id="std-proposals-billy-oneal"><strong>???</strong></span>]</span></p>
</blockquote>
<p>Every implementation surveyed did implement <code>basic_filebuf</code> on top of C stdio, but these platforms also provide functionality for getting a file descriptor out of a <code>FILE*</code>. On every platform, file I/O is ultimately implemented on top of native APIs, so not providing access to a file descriptor from a <code>FILE*</code> would be rather unfortunate. Should such a platform exist, they probably don’t have a conforming C++ implementation anyway.</p>
<p>Additionally, as directed by LEWGI, <code>.native_handle()</code> can just return an invalid handle, if the implementation really can’t get a valid one corresponding to the file.</p>
<h2 id="precendent"><span class="header-section-number">8.2</span> Existing precendent for presence of <code>native_handle</code><a href="#precendent" class="self-link"></a></h2>
<table>
<colgroup>
<col style="width: 50%"></col>
<col style="width: 50%"></col>
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;"><div style="text-align:center">
<strong>Types <em>with</em> a standard way of getting the native handle</strong>
</div></th>
<th style="text-align: left;"><div style="text-align:center">
<strong>Types <em>without</em> a standard way of getting the native handle</strong>
</div></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">- <code>std::thread</code></td>
<td style="text-align: left;">- <code>std::fstream</code>/<code>std::filebuf</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">- <code>std::mutex</code></td>
<td style="text-align: left;">- <code>FILE*</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">- Networking TS <span class="citation" data-cites="N4734">[<a href="#ref-N4734" role="doc-biblioref">N4734</a>]</span> types (e.g. <code>std::net::socket</code>)</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">- LLFIO <span class="citation" data-cites="P1031">[<span class="citeproc-not-found" data-reference-id="P1031"><strong>???</strong></span>]</span> types</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
<p>This paper would move <code>std::fstream</code> and <code>std::filebuf</code> from the right column to the left, where it arguably ought to belong.</p>
<h1 id="standardese"><span class="header-section-number">9</span> Technical Specifications<a href="#standardese" class="self-link"></a></h1>
<p>The wording is based on <span class="citation" data-cites="N4830">[<a href="#ref-N4830" role="doc-biblioref">N4830</a>]</span>.</p>
<h2 id="ft-macro"><span class="header-section-number">9.1</span> Feature test macro<a href="#ft-macro" class="self-link"></a></h2>
<p>This paper proposes adding a feature test macro, called <code>__cpp_lib_fstream_native_handle</code>.</p>
<h2 id="wording"><span class="header-section-number">9.2</span> Wording<a href="#wording" class="self-link"></a></h2>
<h3 id="add-the-following-subsection-into-file-based-streams-file.streams"><span class="header-section-number">9.2.1</span> Add the following subsection into <em>File-based streams</em> [<strong>file.streams</strong>]<a href="#add-the-following-subsection-into-file-based-streams-file.streams" class="self-link"></a></h3>
<p>This subsection is to come between [<strong>fstream.syn</strong>] and [<strong>filebuf</strong>].</p>
<p><em>Note to editor:</em> Replace ? with the appropriate section number. As of <span class="citation" data-cites="N4830">[<a href="#ref-N4830" role="doc-biblioref">N4830</a>]</span>, that would be 29.9.2.</p>
<div class="add" style="color: #006e28">

<blockquote>
<p><strong>?.?.? Native handles [file.native]</strong></p>
<p><span class="marginalizedparent"><a class="marginalized">1</a></span> Several classes described in this section have a member <code>native_handle_type</code>.</p>
<p><span class="marginalizedparent"><a class="marginalized">2</a></span> The type <code>native_handle_type</code> serves as a type representing a platform-specific handle to a file. It models <code>regular</code>, and is trivially copyable and standard layout.</p>
<p><span class="marginalizedparent"><a class="marginalized">3</a></span> [ <em>Note:</em> For operating systems based on POSIX, <code>native_handle_type</code> is <code>int</code>. For Windows-based operating systems, it is <code>HANDLE</code>. — <em>end note</em> ]</p>
</blockquote>

</div>
<h3 id="modify-class-template-basic_filebuf-filebuf"><span class="header-section-number">9.2.2</span> Modify <em>Class template <code>basic_filebuf</code></em> [<strong>filebuf</strong>]<a href="#modify-class-template-basic_filebuf-filebuf" class="self-link"></a></h3>
<div>
<div class="sourceCode" id="cb8"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb8-1"><a href="#cb8-1"></a>namespace std {</span>
<span id="cb8-2"><a href="#cb8-2"></a>  template&lt;class charT, class traits = char_traits&lt;charT&gt;&gt;</span>
<span id="cb8-3"><a href="#cb8-3"></a>  class basic_filebuf : public basic_streambuf&lt;charT, traits&gt; {</span>
<span id="cb8-4"><a href="#cb8-4"></a>  public:</span>
<span id="cb8-5"><a href="#cb8-5"></a>    using char_type   = charT;</span>
<span id="cb8-6"><a href="#cb8-6"></a>    using int_type    = typename traits::int_type;</span>
<span id="cb8-7"><a href="#cb8-7"></a>    using pos_type    = typename traits::pos_type;</span>
<span id="cb8-8"><a href="#cb8-8"></a>    using off_type    = typename traits::off_type;</span>
<span id="cb8-9"><a href="#cb8-9"></a>    using traits_type = traits;</span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="va">+   using native_handle_type = <em>implementation-defined</em>; // see [file.native]</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>    </span>
<span id="cb8-12"><a href="#cb8-12"></a>    // ...</span>
<span id="cb8-13"><a href="#cb8-13"></a></span>
<span id="cb8-14"><a href="#cb8-14"></a>    // 29.9.2.3, members</span>
<span id="cb8-15"><a href="#cb8-15"></a>    bool is_open() const;</span>
<span id="cb8-16"><a href="#cb8-16"></a>    basic_filebuf* open(const char* s, ios_base::openmode mode);</span>
<span id="cb8-17"><a href="#cb8-17"></a>    basic_filebuf* open(const filesystem::path::value_type* s,</span>
<span id="cb8-18"><a href="#cb8-18"></a>                        ios_base::openmode mode);  // wide systems only; see 29.9.1</span>
<span id="cb8-19"><a href="#cb8-19"></a>    basic_filebuf* open(const string&amp; s,</span>
<span id="cb8-20"><a href="#cb8-20"></a>                        ios_base::openmode mode);</span>
<span id="cb8-21"><a href="#cb8-21"></a>    basic_filebuf* open(const filesystem::path&amp; s,</span>
<span id="cb8-22"><a href="#cb8-22"></a>                        ios_base::openmode mode);</span>
<span id="cb8-23"><a href="#cb8-23"></a>    basic_filebuf* close();</span>
<span id="cb8-24"><a href="#cb8-24"></a><span class="va">+   native_handle_type native_handle();</span></span>
<span id="cb8-25"><a href="#cb8-25"></a></span>
<span id="cb8-26"><a href="#cb8-26"></a>    // ...</span>
<span id="cb8-27"><a href="#cb8-27"></a>  }</span>
<span id="cb8-28"><a href="#cb8-28"></a>}</span></code></pre></div>
</div>
<h3 id="modify-class-template-basic_filebuf-filebuf-1"><span class="header-section-number">9.2.3</span> Modify <em>Class template <code>basic_filebuf</code></em> [<strong>filebuf</strong>]<a href="#modify-class-template-basic_filebuf-filebuf-1" class="self-link"></a></h3>
<blockquote>
<p><span class="marginalizedparent"><a class="marginalized">1</a></span> The class <code>basic_filebuf&lt;charT, traits&gt;</code> associates both the input sequence and the output sequence with a file.</p>
<div class="add" style="color: #006e28">
<p><span class="marginalizedparent"><a class="marginalized">2</a></span> The file has an associated value of type <code>native_handle_type</code>, called the <em>native handle</em> of the file. Whether the associated <em>native handle</em> is unique for each file, is implementation-defined.</p>
<p><span class="marginalizedparent"><a class="marginalized">3</a></span> [ <em>Note:</em> This differs from the native handles of <code>thread</code> [thread.req.native], the presence of which is implementation-defined. — <em>end note</em> ]</p>
</div>
<p><span class="marginalizedparent"><a class="marginalized">4</a></span> The restrictions of reading and writing a sequence controlled by an object of class <code>basic_filebuf&lt;charT, traits&gt;</code> are the same as for reading and writing with the C standard library <code>FILE</code>s.</p>
</blockquote>
<h3 id="add-to-the-end-of-member-functions-filebuf.members"><span class="header-section-number">9.2.4</span> Add to the end of <em>Member functions</em> [<strong>filebuf.members</strong>]<a href="#add-to-the-end-of-member-functions-filebuf.members" class="self-link"></a></h3>
<div class="add" style="color: #006e28">

<blockquote>
<div class="sourceCode" id="cb9"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb9-1"><a href="#cb9-1"></a>native_handle_type native_handle();</span></code></pre></div>
<p><em>Expects:</em> <code>is_open()</code> is <code>true</code>.</p>
<p><em>Throws:</em> Nothing.</p>
<p><em>Returns:</em> The <em>native handle</em> of the associated file of <code>*this</code>.</p>
</blockquote>

</div>
<h3 id="modify-class-template-basic_ifstream-ifstream"><span class="header-section-number">9.2.5</span> Modify <em>Class template <code>basic_ifstream</code></em> [<strong>ifstream</strong>]<a href="#modify-class-template-basic_ifstream-ifstream" class="self-link"></a></h3>
<div>
<div class="sourceCode" id="cb10"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb10-1"><a href="#cb10-1"></a>namespace std {</span>
<span id="cb10-2"><a href="#cb10-2"></a>  template&lt;class charT, class traits = char_traits&lt;charT&gt;&gt;</span>
<span id="cb10-3"><a href="#cb10-3"></a>  class basic_ifstream : public basic_istream&lt;charT, traits&gt; {</span>
<span id="cb10-4"><a href="#cb10-4"></a>  public:</span>
<span id="cb10-5"><a href="#cb10-5"></a>    using char_type   = charT;</span>
<span id="cb10-6"><a href="#cb10-6"></a>    using int_type    = typename traits::int_type;</span>
<span id="cb10-7"><a href="#cb10-7"></a>    using pos_type    = typename traits::pos_type;</span>
<span id="cb10-8"><a href="#cb10-8"></a>    using off_type    = typename traits::off_type;</span>
<span id="cb10-9"><a href="#cb10-9"></a>    using traits_type = traits;</span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="va">+   using native_handle_type =</span></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="va">+     typename basic_filebuf&lt;charT, traits&gt;::native_handle_type;</span></span>
<span id="cb10-12"><a href="#cb10-12"></a></span>
<span id="cb10-13"><a href="#cb10-13"></a>    // ...</span>
<span id="cb10-14"><a href="#cb10-14"></a></span>
<span id="cb10-15"><a href="#cb10-15"></a>    // [ifstream.members], members</span>
<span id="cb10-16"><a href="#cb10-16"></a>    basic_filebuf&lt;charT, traits&gt;* rdbuf() const;</span>
<span id="cb10-17"><a href="#cb10-17"></a><span class="va">+   native_handle_type native_handle();</span></span>
<span id="cb10-18"><a href="#cb10-18"></a></span>
<span id="cb10-19"><a href="#cb10-19"></a>    // ...</span>
<span id="cb10-20"><a href="#cb10-20"></a>  }</span>
<span id="cb10-21"><a href="#cb10-21"></a>}</span></code></pre></div>
</div>
<h3 id="add-to-member-functions-ifstream.members-after-p1"><span class="header-section-number">9.2.6</span> Add to <em>Member functions</em> [<strong>ifstream.members</strong>] after p1<a href="#add-to-member-functions-ifstream.members-after-p1" class="self-link"></a></h3>
<blockquote>
<div class="add" style="color: #006e28">

<div class="sourceCode" id="cb11"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb11-1"><a href="#cb11-1"></a>native_handle_type native_handle();</span></code></pre></div>
<p><span class="marginalizedparent"><a class="marginalized">2</a></span> <em>Effects:</em> Equivalent to: <code>return rdbuf()-&gt;native_handle();</code>.</p>
</div>
</blockquote>
<h3 id="modify-class-template-basic_ofstream-ofstream"><span class="header-section-number">9.2.7</span> Modify <em>Class template <code>basic_ofstream</code></em> [<strong>ofstream</strong>]<a href="#modify-class-template-basic_ofstream-ofstream" class="self-link"></a></h3>
<div>
<div class="sourceCode" id="cb12"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb12-1"><a href="#cb12-1"></a>namespace std {</span>
<span id="cb12-2"><a href="#cb12-2"></a>  template&lt;class charT, class traits = char_traits&lt;charT&gt;&gt;</span>
<span id="cb12-3"><a href="#cb12-3"></a>  class basic_ofstream : public basic_ostream&lt;charT, traits&gt; {</span>
<span id="cb12-4"><a href="#cb12-4"></a>  public:</span>
<span id="cb12-5"><a href="#cb12-5"></a>    using char_type   = charT;</span>
<span id="cb12-6"><a href="#cb12-6"></a>    using int_type    = typename traits::int_type;</span>
<span id="cb12-7"><a href="#cb12-7"></a>    using pos_type    = typename traits::pos_type;</span>
<span id="cb12-8"><a href="#cb12-8"></a>    using off_type    = typename traits::off_type;</span>
<span id="cb12-9"><a href="#cb12-9"></a>    using traits_type = traits;</span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="va">+   using native_handle_type =</span></span>
<span id="cb12-11"><a href="#cb12-11"></a><span class="va">+     typename basic_filebuf&lt;charT, traits&gt;::native_handle_type;</span></span>
<span id="cb12-12"><a href="#cb12-12"></a></span>
<span id="cb12-13"><a href="#cb12-13"></a>    // ...</span>
<span id="cb12-14"><a href="#cb12-14"></a></span>
<span id="cb12-15"><a href="#cb12-15"></a>    // [ofstream.members], members</span>
<span id="cb12-16"><a href="#cb12-16"></a>    basic_filebuf&lt;charT, traits&gt;* rdbuf() const;</span>
<span id="cb12-17"><a href="#cb12-17"></a><span class="va">+   native_handle_type native_handle();</span></span>
<span id="cb12-18"><a href="#cb12-18"></a></span>
<span id="cb12-19"><a href="#cb12-19"></a>    // ...</span>
<span id="cb12-20"><a href="#cb12-20"></a>  }</span>
<span id="cb12-21"><a href="#cb12-21"></a>}</span></code></pre></div>
</div>
<h3 id="add-to-member-functions-ofstream.members-after-p1"><span class="header-section-number">9.2.8</span> Add to <em>Member functions</em> [<strong>ofstream.members</strong>] after p1<a href="#add-to-member-functions-ofstream.members-after-p1" class="self-link"></a></h3>
<blockquote>
<div class="add" style="color: #006e28">

<div class="sourceCode" id="cb13"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb13-1"><a href="#cb13-1"></a>native_handle_type native_handle();</span></code></pre></div>
<p><span class="marginalizedparent"><a class="marginalized">2</a></span> <em>Effects:</em> Equivalent to: <code>return rdbuf()-&gt;native_handle();</code>.</p>
</div>
</blockquote>
<h3 id="modify-class-template-basic_fstream-fstream"><span class="header-section-number">9.2.9</span> Modify <em>Class template <code>basic_fstream</code></em> [<strong>fstream</strong>]<a href="#modify-class-template-basic_fstream-fstream" class="self-link"></a></h3>
<div>
<div class="sourceCode" id="cb14"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb14-1"><a href="#cb14-1"></a>namespace std {</span>
<span id="cb14-2"><a href="#cb14-2"></a>  template&lt;class charT, class traits = char_traits&lt;charT&gt;&gt;</span>
<span id="cb14-3"><a href="#cb14-3"></a>  class basic_fstream : public basic_iostream&lt;charT, traits&gt; {</span>
<span id="cb14-4"><a href="#cb14-4"></a>  public:</span>
<span id="cb14-5"><a href="#cb14-5"></a>    using char_type   = charT;</span>
<span id="cb14-6"><a href="#cb14-6"></a>    using int_type    = typename traits::int_type;</span>
<span id="cb14-7"><a href="#cb14-7"></a>    using pos_type    = typename traits::pos_type;</span>
<span id="cb14-8"><a href="#cb14-8"></a>    using off_type    = typename traits::off_type;</span>
<span id="cb14-9"><a href="#cb14-9"></a>    using traits_type = traits;</span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="va">+   using native_handle_type =</span></span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="va">+     typename basic_filebuf&lt;charT, traits&gt;::native_handle_type;</span></span>
<span id="cb14-12"><a href="#cb14-12"></a></span>
<span id="cb14-13"><a href="#cb14-13"></a>    // ...</span>
<span id="cb14-14"><a href="#cb14-14"></a></span>
<span id="cb14-15"><a href="#cb14-15"></a>    // [ofstream.members], members</span>
<span id="cb14-16"><a href="#cb14-16"></a>    basic_filebuf&lt;charT, traits&gt;* rdbuf() const;</span>
<span id="cb14-17"><a href="#cb14-17"></a><span class="va">+   native_handle_type native_handle();</span></span>
<span id="cb14-18"><a href="#cb14-18"></a></span>
<span id="cb14-19"><a href="#cb14-19"></a>    // ...</span>
<span id="cb14-20"><a href="#cb14-20"></a>  }</span>
<span id="cb14-21"><a href="#cb14-21"></a>}</span></code></pre></div>
</div>
<h3 id="add-to-member-functions-fstream.members-after-p1"><span class="header-section-number">9.2.10</span> Add to <em>Member functions</em> [<strong>fstream.members</strong>] after p1<a href="#add-to-member-functions-fstream.members-after-p1" class="self-link"></a></h3>
<blockquote>
<div class="add" style="color: #006e28">

<div class="sourceCode" id="cb15"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb15-1"><a href="#cb15-1"></a>native_handle_type native_handle();</span></code></pre></div>
<p><span class="marginalizedparent"><a class="marginalized">2</a></span> <em>Effects:</em> Equivalent to: <code>return rdbuf()-&gt;native_handle();</code>.</p>
</div>
</blockquote>

<h1 id="acknowledgements"><span class="header-section-number">10</span> Acknowledgements<a href="#acknowledgements" class="self-link"></a></h1>
<p>Thanks to Niall Douglas for feedback, encouragement and ambitious suggestions for this paper.</p>
<p>Thanks to the rest of the co-authors of <span class="citation" data-cites="P1750">[<span class="citeproc-not-found" data-reference-id="P1750"><strong>???</strong></span>]</span> for the idea after cutting this functionality out, especially to Jeff Garland for providing a heads-up about a possible ABI-break that I totally would’ve missed, even though it ended up being a non-issue.</p>
<h1 id="references"><span class="header-section-number">11</span> References<a href="#references" class="self-link"></a></h1>

<div id="refs" role="doc-bibliography">
<div id="ref-N4734">
<p>[N4734] Jonathan Wakely. 2018. Working Draft, C ++ Extensions for Networking. <br />
<a href="https://wg21.link/n4734">https://wg21.link/n4734</a></p>
</div>
<div id="ref-N4830">
<p>[N4830] Richard Smith. 2019. Committee Draft, Standard for Programming Language C++. <br />
<a href="https://wg21.link/n4830">https://wg21.link/n4830</a></p>
</div>
</div>
</div>
</div>
</body>
</html>
